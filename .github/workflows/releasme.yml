name: Release Draft On Master

on:
  push:
    # branches to consider in the event; optional, defaults to all
    branches:
      - master
    # Sequence of patterns matched against refs/tags
    #tags:
    #  - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  build:
    name: Upload Release Asset
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go 1.13
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Get Dependencies
        run: make kruz-get-linux-deps

      - name: Build Container (kube-dialer)
        env:
          DOCKER_IMAGE: kruzio/kube-dialer
        run: make kube-dialer-build-image DOCKER_IMAGE=${DOCKER_IMAGE}

      - name: Login to Github Package Registry
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_GITHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          DOCKER_REGISTRY_URL: "docker.pkg.github.com"

        run: docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REGISTRY_URL}

      - name: Publish Container (kube-dialer)
        env:
          DOCKER_IMAGE: kruzio/kube-dialer
          REPOSITORY: kruzio/kube-dialer
          

        run:  |
          docker tag $DOCKER_IMAGE:latest docker.pkg.github.com/$REPOSITORY:$GITHUB_SHA
          docker tag $DOCKER_IMAGE:latest docker.pkg.github.com/$REPOSITORY:master 
          docker push docker.pkg.github.com/$REPOSITORY:$GITHUB_SHA
          docker push docker.pkg.github.com/$REPOSITORY:master     

      - name: Create Release
        id: create_release
        uses: release-drafter/release-drafter@v5
        with:
          # (Optional) specify config name to use, relative to .github/. Default: release-drafter.yml
          config-name: release-drafter.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: artifacts/kube-dialer-chart.zip
          asset_name: kube-dialer-chart.zip
          asset_content_type: application/zip
