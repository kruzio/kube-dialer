name: Build On Push/Pull Request
on:
  # Trigger the workflow on push or pull request,
  # but only for the master branch
  push:
    branches:
      - '*'
      - '!master'

  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_GITHUB_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      DOCKER_REGISTRY_URL: "docker.pkg.github.com"  
      DOCKER_IMAGE: kruzio/kube-dialer
      REPOSITORY: kruzio/kube-dialer/dialer  

    steps:
    - name: Set up Go 1.13
      uses: actions/setup-go@v1
      with:
        go-version: 1.13
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      run: make kruz-get-linux-deps

    - name: Build It (kube-dialer)
      env:
        DOCKER_IMAGE: kruzio/kube-dialer
      run: |
        make kube-dialer-artifacts
        make kube-dialer-build-image DOCKER_IMAGE=${DOCKER_IMAGE}
        docker tag ${DOCKER_IMAGE}:latest ${REPOSITORY}

    - name: Publish Container (kube-dialer)        
      run:  |
        docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REGISTRY_URL}
        docker tag $DOCKER_IMAGE:latest docker.pkg.github.com/$REPOSITORY:$GITHUB_SHA
        docker tag $DOCKER_IMAGE:latest docker.pkg.github.com/$REPOSITORY:latest 
        docker push docker.pkg.github.com/$REPOSITORY:$GITHUB_SHA
        docker push docker.pkg.github.com/$REPOSITORY:latest

    - name: Upload Artifacts
      uses: actions/upload-artifact@v1
      with:
        name: deployment-files
        path: artifacts/  


  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_GITHUB_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      DOCKER_REGISTRY_URL: "docker.pkg.github.com"  
      DOCKER_IMAGE: kruzio/kube-dialer
      REPOSITORY: kruzio/kube-dialer/dialer    
    steps:

    - name: Check out code
      uses: actions/checkout@v2

    - name: Run chart-testing (lint)
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 
        chmod 700 get_helm.sh 
        ./get_helm.sh
        helm lint deploy/charts/dialer
      
      uses: helm/kind-action@v1.0.0-alpha.3
      with:
        version: v0.7.0
        node_image: v1.16.4
        wait: 5m
        install_local_path_provisioner: true

    - name: Test Chart Installation
      run: |
        kubectl cluster-info
        kubectl create ns kube-dialer
        helm install --namespace kube-dialer --set image.name=docker.pkg.github.com/$REPOSITORY:$GITHUB_SHA kube-dialer deploy/charts/dialer

